{% extends 'main.html'%}
{% load static %}
{% block headcontent %}
{% include 'head.html' with title="Installers App| Login User" %}
{% endblock %}
{% block content %}

<style>
  form {
    position: relative;
    margin: 20px auto;
    width: 300px;
  }

  h3 {
    font-size: 16px;
    font-weight: 600;
    color: rgba(0, 0, 0, 0.8);
  }

  .submit__generated {
    display: inline-block;
    margin-right: 25%;
  }

  .submit__generated span {
    display: inline-block;
    width: 35px;
    height: 35px;
    vertical-align: center;
    line-height: 35px;
    font-weight: bold;
    font-size: 16px;
    color: rgba(0, 0, 0, 0.9);
    text-align: center;
    letter-spacing: 1px;
    text-transform: uppercase;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 4px;
  }

  .submit__generated.valid:after,
  .submit__generated.unvalid:after {
    font-family: vazir;
    font-size: 18px;
    margin-left: 10px;
  }

  .submit__generated.valid:after {
    content: "\f00c";
    color: #2ecc71;
  }

  .submit__generated.unvalid:after {
    content: "\f00d";
    color: #e74c3c;
  }

  .submit__generated.valid .submit__input {
    border: 1px solid #2ecc71;
    color: #2ecc71 !important;
  }

  .submit__generated.unvalid .submit__input {
    border: 1px solid #e74c3c;
    color: #e74c3c;
  }

  .submit__generated .submit__input {
    position: relative;
    outline: 0;
    height: 35px;
    width: 35px;
    border-radius: 4px;
    border: 1px solid #42A0DD;
    color: #42A0DD;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    top: -2px;
  }

  img.refresh {
    margin: 4px 0 0px 5px;
    padding: 5px;
    font-size: 18px;
    color: rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transform-origin: center center;
    transition: transform 0.2s ease-out, color 0.2s ease-out;
  }

  img.refresh:hover {
    color: rgba(0, 0, 0, 0.4);
    transform: rotate(180deg);
  }

  span.submit__error,
  span.submit__error--empty {
    color: #e74c3c;
    position: absolute;
    margin-top: 0px;
    margin-left: 100px;
  }



  .submit:hover {
    background-color: #3498db;
  }

  .submit:active,
  .submit.enter-press,
  .submit.overlay {
    margin: 55px 0 46px 0;
    box-shadow: none;
  }

  .submit__overlay {
    height: 50px;
    width: 110px;
    background-color: rgba(255, 255, 255, 0.8);
    position: absolute;
    margin-top: -90px;
    margin-left: -5px;
  }

  .low-opa {
    opacity: 0.4;
  }

  .fadeOut {
    opacity: 0;
    transform: translateY(10px);
  }

  .fadeIn {
    opacity: 1 !important;
    transform: translateY(0px) !important;
  }

  .form-fields,
  .form-success {
    transition: all 0.2s ease-out;
  }

  .form-success {
    opacity: 0;
    transform: translateY(-10px);
    margin-top: 20px;
  }
</style>

<div class="loginbox rtl-txt">
  <img src="{% static '/images/human-icon-3d-render-illustration.jpg' %}" class="avatar">

  <h1> ورود کاربر </h1>
  <form action="" method="POST" id="login-form">
    {% csrf_token %}
    <p>نام کاربری</p>
    <input type="text" id="username" name="username" placeholder="نام کاربری خود را وارد کنید" required>
    <p>رمزعبور</p>
    <input type="password" id="password" name="password" placeholder="رمزعبور خود را وارد کنید" required>
    <p>لطفا جمع اعداد را درست وارد کنید</p>
    <div class="submit__generated"></div>
    <img width="32" height="32" src="https://img.icons8.com/windows/32/refresh.png" alt="refresh" class="refresh" />
    <input type="submit" value="ورود" name="">
  </form>
  <!-- <a href="" class="rtl-txt">فراموشی رمزعبور</a> -->


  <script>

    var a, b, c,
      submitContent,
      captcha,
      locked,
      validSubmit = false,
      timeoutHandle;
    function generateCaptcha() {
      a = Math.ceil(Math.random() * 10);
      b = Math.ceil(Math.random() * 10);
      c = a + b;
      submitContent = '<span>' + a + '</span> + <span>' + b + '</span>' +
        ' = <input class="submit__input" type="text" maxlength="2" size="2" required />';
      $('.submit__generated').html(submitContent);

      init();
    }
    function checkCaptcha() {
      if (captcha === c) {
        // Pop the green valid icon
        $('.submit__generated')
          .removeClass('unvalid')
          .addClass('valid');
        $('.submit').removeClass('overlay');
        $('.submit__overlay').fadeOut('fast');

        $('.submit__error').addClass('hide').hide();
        $('.submit__error--empty').addClass('hide').hide();
        validSubmit = true;
      }
      else {
        if (captcha === '') {
          $('.submit__error').addClass('hide');
          $('.submit__error--empty').removeClass('hide');
        }
        else {
          $('.submit__error').removeClass('hide');
          $('.submit__error--empty').addClass('hide');
        }
        // Pop the red unvalid icon
        $('.submit__generated')
          .removeClass('valid')
          .addClass('unvalid');
        $('.submit').addClass('overlay');
        $('.submit__overlay').fadeIn('fast');
        validSubmit = false;
      }
      return validSubmit;
    }

    function unlock() { locked = false; }
    $('img.refresh').on('click', function () {
      setTimeout(unlock, 500);
      generateCaptcha();
      setTimeout(checkCaptcha, 0);
    });
    function init() {
      $('#login-form').submit(function (e) {
        e.preventDefault();
        if ($('.submit__generated').hasClass('valid')) {
          // var formValues = [];
          captcha = $('.submit__input').val();
          if (captcha !== '') {
            captcha = Number(captcha);
          }

          checkCaptcha();

          if (validSubmit === true) {
            validSubmit = false;

            let formData = $(this).serialize();
            $.ajax({
              url: '/api/login-user/',
              type: 'POST',
              data: formData,
              success: function (response) {
                console.log(response.user_id);
                createAlert('success', 'ورودکاربر با موفقیت انجام شد.');
                window.location.href = "/profile/"
              },
              error: function () {
                createAlert('danger', 'نام کاربری یا رمزعبور درست نیست!!');
              }
            });

          }
        }
        else {
          return false;
        }
      });


      // Captcha input result handler
      $('.submit__input').on('propertychange change keyup input paste', function () {
        // Prevent the execution on the first number of the string if it's a 'multiple number string'
        // (i.e: execution on the '1' of '12')
        window.clearTimeout(timeoutHandle);
        timeoutHandle = window.setTimeout(function () {
          captcha = $('.submit__input').val();
          if (captcha !== '') {
            captcha = Number(captcha);
          }
          checkCaptcha();
        }, 150);
      });

    }

    generateCaptcha();


    // $('#login-form').submit(function (event) {
    //   event.preventDefault();
    //   let formData = $(this).serialize();
    //   $.ajax({
    //     url: '/api/login-user/',
    //     type: 'POST',
    //     data: formData,
    //     success: function (response) {
    //       console.log(response.user_id);
    //       createAlert('success', 'ورودکاربر با موفقیت انجام شد.');
    //       window.location.href = "/profile/"
    //     },
    //     error: function () {
    //       createAlert('danger', 'نام کاربری یا رمزعبور درست نیست!!');
    //     }
    //   });
    // });



  </script>
  {% endblock content %}